# フィリングと化学ポテンシャル (filling–μ)

本ページでは化学ポテンシャル \(\mu\) とフェルミエネルギー \(E_F\) の意味、および DOS からフィリング \(n\) を求める方法について説明します。正方格子（最近接結合）を例に、数式と実装の要点をまとめます。

---

## 0. 用語と簡単な説明

- 化学ポテンシャル \(\mu\): 粒子を 1 個増やすと系のエネルギーがどれだけ増えるかを表す量。有限温度ではフェルミ分布
  \(f(E,\mu,T)=1/(e^{(E-\mu)/k_B T}+1)\) の中で現れます。
- フェルミエネルギー \(E_F\): 絶対零度 \(T\to0\) における化学ポテンシャルの値。固体では「占有の基準エネルギー」を表します。
- フィリング \(n\): 1 格子サイトあたりの電子数。スピン縮退を含めると一般に \(0\le n\le g_s\,m_{\mathrm{orb}}\)（\(m_{\mathrm{orb}}\) は軌道数、\(g_s\) はスピン縮退）になります。

特に \(T=0\) ではフェルミ分布はステップ関数になり、\(\mu=E_F\) まで状態を埋めていくイメージになります。

---

## 1. 格子（離散バンド）での定義

有限格子（\(N_k\) 個の \(\mathbf k\) 点）での定義は

$$
n(\mu,T)=\frac{g_s}{N_k}\sum_{b,\mathbf k} f\big(\varepsilon_b(\mathbf k)-\mu,T\big),
$$

です。ここで \(b\) はバンドのインデックス、\(g_s\) はスピン縮退（通常 2）、\(N_k\) はBZ内のk点数です。\(N_k\to\infty\) の極限では \(\mathbf k\) 和を積分（BZ 積分）に置き換えられます。
ここで得られるnというのは、BZ内に存在する電子の平均の数である。つまり、バンドが4本であれば、最大のnは8.0となります。

---

## 2. DOS からフィリングを求める一般式

数値的・解析的にフィリングを求めるときは、総和でなく積分を用いたほうが便利な時もあります。その場合は、\(N_k\to\infty\) の極限状態を考えます。その時、状態密度を \(D(E)\) と書くと、一般に

$$
\boxed{\; n(\mu,T)=g_s\int_{-\infty}^{\infty} D(E)\,f(E,\mu,T)\,dE\;}
$$

です。このとき、n~Nに見えるかもしれませんが、ここでいうDOSは単位胞当たりでの、エネルギーバンドに対する状態密度であることに注意してください。つまり、積分全体は「単位胞あたりの電子数」を与えます。

特に \(T=0\) の場合は

$$
\boxed{\; n(\mu,0)=g_s\int_{-\infty}^{\mu} D(E)\,dE = g_s\,N(\mu)\;}
$$

となり、\(N(E)=\int_{-\infty}^E D(\varepsilon)\,d\varepsilon\) は累積状態数です。与えられた \(n\) に対して \(\mu\) を求めるにはこの方程式を解きます（単調な区間なら二分法などで容易に解けます）。

注: \(D(E)\) を「スピン1 つ・1 軌道あたり」で定義するか、最初からスピン分を含めて定義するかで \(g_s\) の扱いが変わります。どちらかに統一してください。

---

## 3. 2D 正方格子（最近接ホッピング）の\(\mu \)–\(n\) 関係

最近接ホッピングの単純正方格子では分散は

$$
\varepsilon(\mathbf k)=-2t(\cos k_x+\cos k_y),\qquad t>0
$$

となり、DOS は \(E=0\) 付近に鞍点（van Hove 点）があり対数的な特徴を持ちます。バンド幅は \([-4t,4t]\) です。粒子–正孔対称性より半分のフィリング（スピンありで \(n=g_s/2\)）のとき \(\mu=0\) となります。

### 3.1 \(\mu\)–\(n\) の関係

![μ vs filling for 2D square TB](figs/mu_vs_filling_tb.png)

- \(T=0\) では \(dn/d\mu=g_s D(\mu)\)。したがって DOS が大きい（van Hove）箇所では \(\mu\) があまり動かず、\(\dfrac{d\mu}{dn}=1/(g_s D(\mu))\) が小さくなります。
- 有限温度ではフェルミ分布が滑らかになるため、\(n(\mu,T)\) も滑らかになります。

![2D square TB DOS](figs/dos_square_tb.png)

---

## 4. 実務 — \(n\) から \(\mu\) を求めるアルゴリズム

- \(T=0\): 累積分布 \(N(E)\) を作り、目標の割合 \(p=n/g_s\) に対するエネルギーの分位点（quantile）を取ることで直接求まります（\(\mu=\) quantile）。
- \(T>0\): \(F(\mu)=g_s\int D(E) f(E,\mu,T)\,dE - n\) を定義して数値的に根を探します（単調性を利用して二分法や補間で高速に求まります）。

数値実装の要点:

1. \(\mathbf k\) 格子を作って分散 \(\varepsilon(\mathbf k)\) を評価し、1D 配列にして扱うのが簡単です。

```python
# kx, ky in [-pi, pi] (a=1) and energy array Ek
a = 1.0; t = 1.0; Nk = 601
kx = np.linspace(-np.pi, np.pi, Nk)
ky = np.linspace(-np.pi, np.pi, Nk)
KX, KY = np.meshgrid(kx, ky, indexing="xy")
Ek = -2.0 * t * (np.cos(KX) + np.cos(KY))
Ek = Ek.ravel()
```

2. フェルミ関数と \(n(\mu)\) の評価

```python
def fermi(E, mu, kBT):
    if kBT == 0.0:
        return (E < mu).astype(float)
    x = np.clip((E - mu) / (kBT + 1e-15), -50.0, 50.0)
    return 1.0 / (np.exp(x) + 1.0)

def n_of_mu(Ek, mu, kBT, gs):
    return float(gs * fermi(Ek, mu, kBT).mean())
```

3. 反転（\(n\to\mu\)）

- \(T=0\): ソートした \(Ek\) の分位点を用いる。\(p=\text{clip}(n/g_s,0,1)\) として \(\mu=\) quantile。
- \(T>0\): \(\mu\) グリッドを作って \(n(\mu)\) を評価し、単調性を利用して線形補間などで逆写像を得る。

---

## 5. 実用上の設定

- 既定ではスピン縮退 \(g_s=2\)。
- エネルギーは \(t=1\) を単位として無次元化されることが多い（\(E/t\)、\(k_B T/t\) で扱う）。
- 積分（\(\mathbf k\) サンプリング）の分解能は図描画レベルで \(N\approx 400\sim800\) 程度が目安。

実装参照: `scripts/filling_mu_tb.py`

---

### 補記: グラフ

![filling vs μ for 2D square TB](figs/filling_mu_tb.png)

---

### 補記: フェルミエネルギーの意味

- 平衡で粒子数が保存される系では、\(\mu\) は粒子数を保つためのラグランジュ乗数であり、\(T\to0\) で \(E_F\) に一致します。
- 複数バンドがある場合は全バンドの DOS を合算して扱います。DOS が急峻（van Hove）だと、\(\mu\) の微小変化が \(n\) に大きく影響します。

<!--fswatch-test: 2025-10-24T23:27:32.3617513+09:00-->

"""
